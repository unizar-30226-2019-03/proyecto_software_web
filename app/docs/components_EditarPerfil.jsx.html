<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/EditarPerfil.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/EditarPerfil.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { Component } from "react";
import BarraNavegacion from "./BarraNavegacion";
import { Helmet } from "react-helmet";
import { Button, Form, Col } from "react-bootstrap";
import { Redirect, Link } from "react-router-dom";
import {
  isSignedIn,
  getUserID,
  restriccionNombre,
  restriccionUser,
  emailPattern,
  restriccion,
  getUserRole
} from "../config/Auth";
import { checkFileExtensionImage } from "../config/Process";
import { getUser, updateUser } from "../config/UserAPI";
import {
  getUnivesities,
  getDegreesFromUnivesity
} from "../config/UniversityAPI";
import { LoadingSpinUniCast } from "./LoadingSpin";

const FormularioDatos = (
  handleSubmit,
  nombre,
  apellidos,
  userID,
  email,
  passwd,
  passwd2,
  foto,
  universidad,
  carrera,
  user,
  description,
  handleChangeDescription,
  img_valida,
  nombreInvalido,
  apellidoInvalido,
  userInvalido,
  emailInvalido,
  passNoIguales,
  passNoValida,
  listaUniversidades,
  listaCarreras,
  handleChangeUni,
  mostrarSpin,
  handleSpin
) => {
  return (
    &lt;div style={{ margin: "0 20% 0 0" }}>
      &lt;Form
        onSubmit={e => {
          handleSubmit(e);
          handleSpin();
        }}
      >
        &lt;Form.Row>
          &lt;Form.Group as={Col} controlId="formGridName">
            &lt;Form.Label style={{ color: nombreInvalido ? "red" : "black" }}>
              {nombreInvalido ? "Nombre inválido" : "Nombre *"}
            &lt;/Form.Label>
            &lt;Form.Control
              type="text"
              defaultValue={user.name}
              required
              ref={nombre}
            />
          &lt;/Form.Group>

          &lt;Form.Group as={Col} controlId="formGridSurname">
            &lt;Form.Label style={{ color: apellidoInvalido ? "red" : "black" }}>
              {apellidoInvalido ? "Apellidos inválido" : "Apellidos *"}
            &lt;/Form.Label>
            &lt;Form.Control
              type="text"
              defaultValue={user.surnames}
              required
              ref={apellidos}
            />
          &lt;/Form.Group>
        &lt;/Form.Row>

        &lt;Form.Group controlId="formGridUserID">
          &lt;Form.Label style={{ color: userInvalido ? "red" : "black" }}>
            {userInvalido
              ? "Nombre de usuario inválido"
              : "Nombre de usuario *"}
          &lt;/Form.Label>
          &lt;Form.Control
            type="text"
            defaultValue={user.username}
            required
            ref={userID}
          />
        &lt;/Form.Group>

        &lt;Form.Group controlId="formGridEmail">
          &lt;Form.Label style={{ color: emailInvalido ? "red" : "black" }}>
            {emailInvalido ? "Email inválido" : "Email *"}
          &lt;/Form.Label>
          &lt;Form.Control
            defaultValue=""
            type="email"
            placeholder="Si no escribe nada no se modificará su correo"
            ref={email}
          />
        &lt;/Form.Group>
        &lt;Form.Row>
          &lt;Form.Group as={Col} controlId="formGridPasswd">
            {passNoValida ? (
              &lt;Form.Label style={{ color: "red" }}>
                Contraseña inválida
              &lt;/Form.Label>
            ) : passNoIguales ? (
              &lt;Form.Label style={{ color: "red" }}>
                Contraseñas no iguales
              &lt;/Form.Label>
            ) : (
              &lt;Form.Label>Contraseña*&lt;/Form.Label>
            )}
            &lt;Form.Control
              placeholder="Si no escribe nada no se modificará su contraseña"
              defaultValue=""
              type="password"
              ref={passwd}
            />
          &lt;/Form.Group>

          &lt;Form.Group as={Col} controlId="formGridPasswd2">
            &lt;Form.Label>Confirmar contraseña *&lt;/Form.Label>
            &lt;Form.Control defaultValue="" type="password" ref={passwd2} />
          &lt;/Form.Group>
        &lt;/Form.Row>
        &lt;Form.Row>
          &lt;Form.Group as={Col} controlId="formGridUni">
            &lt;Form.Label>¿En qué universidad estudias?&lt;/Form.Label>
            &lt;Form.Control
              as="select"
              ref={universidad}
              onChange={e => handleChangeUni(e)}
            >
              &lt;option value={0}>Elige una universidad...&lt;/option>
              {listaUniversidades.map(e => {
                const { id, name } = e;
                return (
                  &lt;option key={id} value={id}>
                    {name}
                  &lt;/option>
                );
              })}
            &lt;/Form.Control>
          &lt;/Form.Group>
          &lt;Form.Group as={Col} controlId="formGridCarrera">
            &lt;Form.Label>¿Qué carrera?&lt;/Form.Label>
            &lt;Form.Control as="select" ref={carrera}>
              &lt;option value={0}>Elige una carrera...&lt;/option>
              {listaCarreras.map(e => {
                const { id, name } = e;
                return (
                  &lt;option key={id} value={id}>
                    {name}
                  &lt;/option>
                );
              })}
            &lt;/Form.Control>
          &lt;/Form.Group>
        &lt;/Form.Row>

        &lt;Form.Group controlId="formGridFoto">
          &lt;Form.Label style={{ color: img_valida ? "black" : "red" }}>
            {img_valida ? "Foto de usuario" : "Formato de imagen inválido"}
          &lt;/Form.Label>
          &lt;div style={{ display: "flex" }}>
            &lt;Form.Control
              type="file"
              accept="image/*"
              ref={foto}
              onChange={event => {
                var output = document.getElementById("output");
                output.src = URL.createObjectURL(event.target.files[0]);
              }}
            />
            &lt;img
              id="output"
              src={user.photo}
              alt="Foto de perfil"
              width="60px"
              height="60px"
              style={{ marginTop: "-10px", borderRadius: "50%" }}
            />
          &lt;/div>
        &lt;/Form.Group>

        &lt;Form.Group controlId="exampleForm.ControlTextarea1">
          &lt;Form.Label>Descripción&lt;/Form.Label>
          &lt;Form.Control
            as="textarea"
            value={description}
            onChange={handleChangeDescription}
            rows="3"
            style={{ resize: "none" }}
          />
        &lt;/Form.Group>

        &lt;Button
          className="boton-filtro"
          style={{ float: "right", width: "130px", position: "relative" }}
          type="submit"
        >
          Confirmar
          {mostrarSpin ? (
            &lt;LoadingSpinUniCast className="spin-editar-perfil" />
          ) : null}
        &lt;/Button>

        &lt;Link to="/perfil">
          &lt;Button
            className="boton-filtro"
            style={{
              float: "left",
              marginBottom: "20px"
            }}
          >
            Cancelar
          &lt;/Button>
        &lt;/Link>
      &lt;/Form>
    &lt;/div>
  );
};

class EditarPerfil extends Component {
  constructor(props) {
    super(props);
    this._isMounted = false;
    this.state = {
      contentMargin: "300px",
      datosValidados: false,
      datosInvalidos: false,
      passValida: -1,
      listaUniversidades: [],
      listaCarreras: [],
      user: {},
      description: "",
      img_valida: true,
      nombreInvalido: false,
      apellidoInvalido: false,
      userInvalido: false,
      emailInvalido: false,
      passNoIguales: false,
      passNoValida: false,
      mostrarSpin: false
    };
    this.nombre = React.createRef();
    this.apellidos = React.createRef();
    this.email = React.createRef();
    this.userID = React.createRef();
    this.pass = React.createRef();
    this.pass2 = React.createRef();
    this.foto = React.createRef();
    this.universidad = React.createRef();
    this.carrera = React.createRef();
    this.getData = this.getData.bind(this);
    this.handleSpin = this.handleSpin.bind(this);
    this.handleSubmitDatos = this.handleSubmitDatos.bind(this);
    this.handleChange = this.handleChange.bind(this);
    this.handleChangeUni = this.handleChangeUni.bind(this);
    this.handleChangeDescription = this.handleChangeDescription.bind(this);
    this.getAllUniversities = this.getAllUniversities.bind(this);
  }

  getData() {
    getUser(getUserID(), u => {
      if (this._isMounted) {
        this.setState({ user: u, description: u.description });
      }
    });
    getUnivesities(0, data => {
      if (data._embedded.universities.length === 20) {
        this.getAllUniversities(data._embedded.universities, 1);
      } else {
        if (this._isMounted) {
          this.setState({ listaUniversidades: data._embedded.universities });
        }
      }
    });
  }

  componentWillMount() {
    this._isMounted = true;
    if (isSignedIn()) {
      this.getData();
    }
  }

  componentWillUnmount() {
    this._isMounted = false;
  }

  handleSpin() {
    const nombre = this.nombre.current.value;
    const apellidos = this.apellidos.current.value;
    const userID = this.userID.current.value;
    const email = this.email.current.value;
    const pass = this.pass.current.value;
    const pass2 = this.pass2.current.value;
    const foto = this.foto.current.value;
    let ok = true;
    if (!nombre.match(restriccionNombre)) {
      ok = false;
    }
    if (!apellidos.match(restriccionNombre)) {
      ok = false;
    }
    if (!userID.match(restriccionUser)) {
      ok = false;
    }
    if (!email.match(emailPattern)) {
      if (email !== "") {
        ok = false;
      }
    }
    if (pass.match(restriccion)) {
      if (pass !== pass2) {
        ok = false;
      }
    } else {
      if (pass !== "") {
        ok = false;
      }
    }
    if (!checkFileExtensionImage(foto) &amp;&amp; foto !== "") {
      ok = false;
    }

    if (this._isMounted &amp;&amp; ok) {
      this.setState({ mostrarSpin: true });
    }
  }

  getAllUniversities(unis, page) {
    if (unis.length &lt; 20 * page) {
      if (this._isMounted) {
        this.setState({ listaUniversidades: unis });
      }
    } else {
      getUnivesities(page, data => {
        const newData = [...unis, ...data._embedded.universities];
        this.getAllUniversities(newData, page + 1);
      });
    }
  }

  handleChangeUni(e) {
    const uniId = parseInt(e.target.value);
    //ACTUALIZAR LISTA DE CARRERAS (getDegreesFromUniversity)
    getDegreesFromUnivesity(uniId, data => {
      this.setState({ listaCarreras: data._embedded.degrees });
    });
  }

  handleChangeDescription(e) {
    this.setState({ description: e.target.value });
  }
  /**
   * Comprueba que nombre, apellidos, userID, email, pass y pass2, y foto son correctas.
   * De ser así, actualiza el usuario. Si se ha actualizado el usuario, pondrá datosValidos a true,
   * y datosInvalidos a false. En el caso contrario será al reves.
   * @param {*} event 
   */
  handleSubmitDatos(event) {
    event.preventDefault();
    const nombre = this.nombre.current.value;
    const apellidos = this.apellidos.current.value;
    const userID = this.userID.current.value;
    const email = this.email.current.value;
    const pass = this.pass.current.value;
    const pass2 = this.pass2.current.value;
    const foto = this.foto.current.value;
    const descripcion = this.state.description;
    const universidad = parseInt(this.universidad.current.value);
    const carrera = parseInt(this.carrera.current.value);
    let ok = true;

    //Comporobar nombre y apellidos
    if (!nombre.match(restriccionNombre)) {
      ok = false;
      this.setState({ nombreInvalido: true });
    } else {
      this.setState({ nombreInvalido: false });
    }
    if (!apellidos.match(restriccionNombre)) {
      ok = false;
      this.setState({ apellidoInvalido: true });
    } else {
      this.setState({ apellidoInvalido: false });
    }

    //Comprobar nombre de usuario
    if (!userID.match(restriccionUser)) {
      ok = false;
      this.setState({ userInvalido: true });
    } else {
      this.setState({ userInvalido: false });
    }

    // Comprobar email
    if (!email.match(emailPattern)) {
      if (email !== "") {
        ok = false;
        this.setState({ emailInvalido: true });
      }
    } else {
      this.setState({ emailInvalido: false });
    }

    //Comprobar passwords
    if (pass.match(restriccion)) {
      if (pass !== pass2) {
        ok = false;
        this.setState({ passNoIguales: true, passNoValida: false });
      } else {
        this.setState({ passNoIguales: false, passNoValida: false });
      }
    } else {
      if (pass !== "") {
        ok = false;
        this.setState({ passNoValida: true });
      }
    }

    //Comprobar imagen
    if (!checkFileExtensionImage(foto) &amp;&amp; foto !== "") {
      ok = false;
      this.setState({ img_valida: false });
    }

    if (ok) {
      updateUser(
        userID,
        pass,
        email,
        descripcion,
        nombre,
        apellidos,
        universidad,
        carrera,
        this.foto.current.files[0],
        updated => {
          if (updated) {
            if (this._isMounted) {
              this.setState({ datosValidados: true, datosInvalidos: false });
            }
          } else {
            if (this._isMounted) {
              this.setState({
                datosValidados: false,
                datosInvalidos: true,
                mostrarSpin: false
              });
            }
          }
        }
      );
    } else {
      if (this._isMounted) {
        this.setState({ datosValidados: false, datosInvalidos: true });
      }
    }
  }

  handleChange(display) {
    if (display) {
      this.setState({
        contentMargin: "300px"
      });
    } else {
      this.setState({
        contentMargin: "70px"
      });
    }
  }

  render() {
    return !isSignedIn() || getUserRole() === "ROLE_ADMIN" ? (
      &lt;Redirect
        to={{
          pathname: "/",
          state: {
            url: `/perfil`
          }
        }}
      />
    ) : (
      &lt;div>
        &lt;Helmet>
          &lt;title>Editar Perfil | UniCast&lt;/title>
          &lt;style>{"body { background-color: #fafafa; }"}&lt;/style>
        &lt;/Helmet>
        {this.state.datosValidados ? (
          &lt;Redirect to={"/perfil"} />
        ) : (
          &lt;div>
            &lt;BarraNavegacion
              onChange={this.handleChange}
              activar={""}
              displaySide={true}
              hide={false}
            />
            &lt;div
              className="transform"
              style={{
                marginLeft: this.state.contentMargin,
                marginTop: "80px"
              }}
            >
              &lt;h5
                style={{
                  color: this.state.datosInvalidos ? "red" : "black"
                }}
              >
                {this.state.datosInvalidos
                  ? "No se ha podido actualizar el usuario, compruebe los datos"
                  : "Editar perfil"}
              &lt;/h5>
              &lt;div>
                {FormularioDatos(
                  this.handleSubmitDatos,
                  this.nombre,
                  this.apellidos,
                  this.userID,
                  this.email,
                  this.pass,
                  this.pass2,
                  this.foto,
                  this.universidad,
                  this.carrera,
                  this.state.user,
                  this.state.description,
                  this.handleChangeDescription,
                  this.state.img_valida,
                  this.state.nombreInvalido,
                  this.state.apellidoInvalido,
                  this.state.userInvalido,
                  this.state.emailInvalido,
                  this.state.passNoIguales,
                  this.state.passNoValida,
                  this.state.listaUniversidades,
                  this.state.listaCarreras,
                  this.handleChangeUni,
                  this.state.mostrarSpin,
                  this.handleSpin
                )}
              &lt;/div>
            &lt;/div>
          &lt;/div>
        )}
      &lt;/div>
    );
  }
}

export default EditarPerfil;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="BarraNavegacion.html">BarraNavegacion</a></li><li><a href="Notificacion.html">Notificacion</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addComment">addComment</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addProfessor">addProfessor</a></li><li><a href="global.html#addReproductionList">addReproductionList</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#addVideotoReproductionList">addVideotoReproductionList</a></li><li><a href="global.html#addVote">addVote</a></li><li><a href="global.html#authUser">authUser</a></li><li><a href="global.html#borrarAsignatura">borrarAsignatura</a></li><li><a href="global.html#borrarProfeAsignatura">borrarProfeAsignatura</a></li><li><a href="global.html#borrarProfesor">borrarProfesor</a></li><li><a href="global.html#borrarUniversidad">borrarUniversidad</a></li><li><a href="global.html#checkFileExtensionImage">checkFileExtensionImage</a></li><li><a href="global.html#checkFileExtensionVideo">checkFileExtensionVideo</a></li><li><a href="global.html#checkNotification">checkNotification</a></li><li><a href="global.html#crearAsigYLigar">crearAsigYLigar</a></li><li><a href="global.html#crearCarreraYLigar">crearCarreraYLigar</a></li><li><a href="global.html#crearUniversidad">crearUniversidad</a></li><li><a href="global.html#deleteProfessor">deleteProfessor</a></li><li><a href="global.html#deleteReproductionList">deleteReproductionList</a></li><li><a href="global.html#deleteVideo">deleteVideo</a></li><li><a href="global.html#deleteVideoFromDisplay">deleteVideoFromDisplay</a></li><li><a href="global.html#deleteVideoFromReproductionList">deleteVideoFromReproductionList</a></li><li><a href="global.html#diasDelMes">diasDelMes</a></li><li><a href="global.html#emailPattern">emailPattern</a></li><li><a href="global.html#esAyer">esAyer</a></li><li><a href="global.html#esBisiesto">esBisiesto</a></li><li><a href="global.html#f_filterResults">f_filterResults</a></li><li><a href="global.html#f_scrollTop">f_scrollTop</a></li><li><a href="global.html#findSubjectByName">findSubjectByName</a></li><li><a href="global.html#findSubjectsContainingName">findSubjectsContainingName</a></li><li><a href="global.html#findUserProfessors">findUserProfessors</a></li><li><a href="global.html#findVideosContainingTitle">findVideosContainingTitle</a></li><li><a href="global.html#generadorColores">generadorColores</a></li><li><a href="global.html#getCommentsByVideo">getCommentsByVideo</a></li><li><a href="global.html#getDegreeOfUser">getDegreeOfUser</a></li><li><a href="global.html#getDegreesFromUnivesity">getDegreesFromUnivesity</a></li><li><a href="global.html#getDisplaysByUser">getDisplaysByUser</a></li><li><a href="global.html#getLastMessages">getLastMessages</a></li><li><a href="global.html#getMessagesFromSender">getMessagesFromSender</a></li><li><a href="global.html#getMessagesToReceiver">getMessagesToReceiver</a></li><li><a href="global.html#getProfessorsFromSubject">getProfessorsFromSubject</a></li><li><a href="global.html#getRecommendations">getRecommendations</a></li><li><a href="global.html#getReproductionListVideoIn">getReproductionListVideoIn</a></li><li><a href="global.html#getScore">getScore</a></li><li><a href="global.html#getSubjectById">getSubjectById</a></li><li><a href="global.html#getSubjectRanking">getSubjectRanking</a></li><li><a href="global.html#getSubjectsAsProfessor">getSubjectsAsProfessor</a></li><li><a href="global.html#getSubjectsFromUniveristy">getSubjectsFromUniveristy</a></li><li><a href="global.html#getSubjectsOfUser">getSubjectsOfUser</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getTimePassed">getTimePassed</a></li><li><a href="global.html#getUniversityOfUser">getUniversityOfUser</a></li><li><a href="global.html#getUnivesities">getUnivesities</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#getUserByUsername">getUserByUsername</a></li><li><a href="global.html#getUserID">getUserID</a></li><li><a href="global.html#getUserNotifications">getUserNotifications</a></li><li><a href="global.html#getUserPhoto">getUserPhoto</a></li><li><a href="global.html#getUserReproductionLists">getUserReproductionLists</a></li><li><a href="global.html#getUserRole">getUserRole</a></li><li><a href="global.html#getUserToken">getUserToken</a></li><li><a href="global.html#getUserUncheckedNotifications">getUserUncheckedNotifications</a></li><li><a href="global.html#getVideo">getVideo</a></li><li><a href="global.html#getVideoDisplay">getVideoDisplay</a></li><li><a href="global.html#getVideosFromReproductionList">getVideosFromReproductionList</a></li><li><a href="global.html#getVideosFromSubject">getVideosFromSubject</a></li><li><a href="global.html#getVideosFromUploader">getVideosFromUploader</a></li><li><a href="global.html#getVideoSubject">getVideoSubject</a></li><li><a href="global.html#hacerProfesor">hacerProfesor</a></li><li><a href="global.html#isSignedIn">isSignedIn</a></li><li><a href="global.html#ligarUniAsig">ligarUniAsig</a></li><li><a href="global.html#ligarUniCarr">ligarUniCarr</a></li><li><a href="global.html#mergeSortedArray">mergeSortedArray</a></li><li><a href="global.html#parsearFecha">parsearFecha</a></li><li><a href="global.html#parseNewMessages">parseNewMessages</a></li><li><a href="global.html#putFavouritesFirst">putFavouritesFirst</a></li><li><a href="global.html#RemoveAccents">RemoveAccents</a></li><li><a href="global.html#restriccion">restriccion</a></li><li><a href="global.html#restriccionNombre">restriccionNombre</a></li><li><a href="global.html#restriccionUser">restriccionUser</a></li><li><a href="global.html#scrollFunc">scrollFunc</a></li><li><a href="global.html#setUserPhoto">setUserPhoto</a></li><li><a href="global.html#setUserRole">setUserRole</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#signOut">signOut</a></li><li><a href="global.html#SubscribeSubject">SubscribeSubject</a></li><li><a href="global.html#UnsubscribeSubject">UnsubscribeSubject</a></li><li><a href="global.html#updateDisplay">updateDisplay</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#UploadVideo">UploadVideo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Tue May 28 2019 18:26:06 GMT+0200 (hora de verano de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
