<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/BarraNavegacion.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/BarraNavegacion.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Fichero BarraNavegacion.jsx donde se encuentra la clase
 * que renderiza la barra de navegación de la aplicación, y la clase Notificacion
 * que renderiza una notificación recibida de nuevo mensaje o vídeo
 *
 * @author UniCast
 *
 * @requires ../node_modules/react-router-dom/Link.js:Link
 * @requires ../../node_modules/react-bootstrap/NavBar.js:NavBar
 * @requires ../../node_modules/react-bootstrap/Nav.js:Nav
 * @requires ../../node_modules/react-icons/fa/FaBell.js:FaBell
 * @requires ../../node_modules/react-icons/fa/FaEnvelope.js:FaEnvelope
 * @requires ../../node_modules/react-icons/fa/FaBars.js:FaBars
 * @requires ./BarraBusqueda.jsx:BarraBusqueda
 * @requires ./BarraLateral.jsx:BarraLateral
 * @requires ../config/Auth.jsx:signOut
 * @requires ../config/Auth.jsx:isSignedIn
 * @requires ../config/Auth.jsx:getUserPhoto
 * @requires ../config/Auth.jsx:getUserRole
 * @requires ../config/NotificationAPI.jsx:getUserUncheckedNotifications
 * @requires ../config/NotificationAPI.jsx:checkNotification
 * @requires ../config/VideoAPI.jsx:getTimePassed
 * @requires ../config/UserAPI.jsx:getUser
 * @requires ../config/SubjectAPI.jsx:getSubjectById
 */

import React, { Component } from "react";
import { Link } from "react-router-dom";
import brand from "../assets/imgUnicast.jpg";
import { Navbar, Nav } from "react-bootstrap";
import { FaBell, FaEnvelope, FaBars } from "react-icons/fa";
import BarraBusqueda from "./BarraBusqueda";
import BarraLateral from "./BarraLateral";
import { signOut, isSignedIn, getUserPhoto, getUserRole } from "../config/Auth";
import {
  getUserUncheckedNotifications,
  checkNotification
} from "../config/NotificationAPI";
import { getTimePassed } from "../config/VideoAPI";
import { getUser } from "../config/UserAPI";
import { getSubjectById } from "../config/SubjectAPI";

/**
 * Clase que gestiona una notificación individual, permitiendo
 * ser mostrada y revisada.
 * @extends Component
 */
class Notificacion extends Component {
  /**
   * Construye el componente Notificacion
   *
   * @param {Object} props Propiedades para inicializar el componente
   * @param {Date} props.now Timestamp del servidor
   * @param {Object} props.notif Notificación
   */
  constructor(props) {
    super(props);
    /**
     * Indica si el componente está montado o no
     * @type {Boolean}
     */
    this._isMounted = false;
    this.state = {
      unChecked: true,
      timeNow: props.now,
      notif: props.notif,
      mensaje: "",
      mostrarSpin: true
    };

    this.getUserNotif = this.getUserNotif.bind(this);
    this.getSubjectNotif = this.getSubjectNotif.bind(this);
  }

  componentWillMount() {
    this._isMounted = true;
    if (isSignedIn()) {
      if (this.props.notif.notificationCategory === "messages") {
        this.getUserNotif();
      } else {
        this.getSubjectNotif();
      }
    }
  }

  /**
   * Obtiene el usuario que ha enviado un
   * mensaje generando una notificación
   */
  getUserNotif() {
    getUser(this.props.notif.creatorId, data => {
      if (this._isMounted) {
        this.setState({ mensaje: data.username, mostrarSpin: false });
      }
    });
  }

  /**
   * Obtiene la asignatura que ha subido un
   * vídeo generando una notificación
   */
  getSubjectNotif() {
    getSubjectById(this.props.notif.creatorId, data => {
      if (this._isMounted) {
        this.setState({ mensaje: data.name, mostrarSpin: false });
      }
    });
  }

  componentWillUnmount() {
    this._isMounted = false;
  }

  render() {
    return (
      &lt;div>
        {this.state.notif.notificationCategory === "videos" ? (
          &lt;Link
            to={`/asig/${this.state.notif.creatorId}`}
            onMouseEnter={() => {
              checkNotification(this.state.notif.id, ok => {
                if (ok) {
                  this.setState({ unChecked: false });
                }
              });
            }}
            style={{
              position: "relative"
            }}
          >
            &lt;span
              className="notificacion-mensaje"
              style={{
                visibility: this.state.unChecked ? "visible" : "hidden"
              }}
            />
            &lt;span
              style={{
                width: "155px",
                display: "inline-block"
              }}
            >
              {this.state.mostrarSpin
                ? "Cargando..."
                : `Nuevo vídeo de ${this.state.mensaje}`}
            &lt;/span>
            &lt;span
              style={{
                marginLeft: "20px",
                color: "#00000080",
                fontSize: "12px"
              }}
            >
              {this.state.mostrarSpin
                ? null
                : `Hace 
              ${getTimePassed(this.state.notif.timestamp, this.state.timeNow)}`}
            &lt;/span>
          &lt;/Link>
        ) : (
          &lt;Link
            to={`/chat/${this.state.notif.creatorId}`}
            onMouseEnter={() => {
              checkNotification(this.state.notif.id, ok => {
                if (ok) {
                  this.setState({ unChecked: false });
                }
              });
            }}
            style={{
              position: "relative"
            }}
          >
            &lt;span
              className="notificacion-mensaje"
              style={{
                visibility: this.state.unChecked ? "visible" : "hidden"
              }}
            />
            {this.state.mostrarSpin
              ? "Cargando..."
              : `Nuevo mensaje de ${this.state.mensaje}`}
            &lt;span
              style={{
                marginLeft: "10px",
                color: "#00000080",
                fontSize: "12px"
              }}
            >
              {this.state.mostrarSpin
                ? null
                : `Hace 
              ${getTimePassed(this.state.notif.timestamp, this.state.timeNow)}`}
            &lt;/span>
          &lt;/Link>
        )}
      &lt;/div>
    );
  }
}

/**
 * Clase que gestiona la barra de navegación, controlando a su
 * vez la barra lateral y la barra de búsqueda
 * @extends Component
 */
class BarraNavegacion extends Component {
  /**
   * Construye el componente BarraNavegacion
   *
   * @param {Object} props Propiedades para inicializar el componente
   * @param {Boolean} props.displaySide Indica si mostrar la barra lateral o no
   * @param {Boolean} props.hide Indica si el usuario ha pulsado esconder barra lateral
   * @param {String} props.nuevoTit Texto introducido para realizar la búsqueda de resultados
   */
  constructor(props) {
    super(props);
    /**
     * Indica si el componente está montado o no
     * @type {Boolean}
     */
    this._isMounted = false;
    this.state = {
      displayMenu: false,
      displaySide: props.displaySide,
      windowWidth: window.innerWidth,
      displayNotif: false,
      hide: props.hide,
      busqueda: props.nuevoTit,
      unCheckedNotifications: [],
      bolaNotif: false,
      tiempoCheck: 0,
      timeNow: new Date()
    };
    this.showDropdown = this.showDropdown.bind(this);
    this.hideDropdown = this.hideDropdown.bind(this);
    this.showSideBar = this.showSideBar.bind(this);
    this.resize = this.resize.bind(this);
    this.getNotifications = this.getNotifications.bind(this);
    this.showDropdownNotif = this.showDropdownNotif.bind(this);
    this.hideDropdownNotif = this.hideDropdownNotif.bind(this);
    this.iniciarReloj = this.iniciarReloj.bind(this);
    this.pararReloj = this.pararReloj.bind(this);
    this.tick = this.tick.bind(this);
  }

  /**
   * Obtiene las notificaciones no revisadas de
   * un usuario
   */
  getNotifications() {
    getUserUncheckedNotifications(0, (data, now) => {
      if (!this.state.displayNotif) {
        if (this.props.onChat !== undefined) {
          const idCreator = parseInt(this.props.onChat);
          var newNotifications = [];
          data.forEach(elmnt => {
            const notif = elmnt.notification;
            if (notif.notificationCategory !== "messages") {
              newNotifications.push(elmnt);
            } else {
              if (notif.creatorId !== idCreator) {
                newNotifications.push(elmnt);
              } else {
                //Check notification
                checkNotification(notif.id);
              }
            }
          });
          if (this._isMounted) {
            this.setState({
              unCheckedNotifications: newNotifications,
              timeNow: now
            });
            if (newNotifications.length > 0) {
              this.setState({ bolaNotif: true });
            }
          }
        } else {
          if (this._isMounted) {
            this.setState({ unCheckedNotifications: data, timeNow: now });
            if (data.length > 0) {
              this.setState({ bolaNotif: true });
            }
          }
        }
      }
      this.iniciarReloj();
    });
  }

  componentWillMount() {
    this._isMounted = true;
    if (isSignedIn()) {
      this.getNotifications();
    }
  }

  componentDidMount() {
    window.addEventListener("resize", this.resize);
  }

  componentWillUnmount() {
    this._isMounted = false;
    this.pararReloj();
    window.removeEventListener("resize", this.resize);
    document.removeEventListener("click", this.hideDropdown);
    document.removeEventListener("click", this.hideDropdownNotif);
  }

  componentWillReceiveProps(newProps) {
    this.setState({ busqueda: newProps.nuevoTit });
  }

  /**
   * Dependiendo del ancho de la pantalla y si el usuario
   * ha pulsado esconder barra lateral o no, muestra o esconde
   * la barra lateral.
   */
  resize() {
    let currentWidthNav = window.innerWidth &lt;= 991;
    if (currentWidthNav &amp;&amp; this.state.windowWidth > 991) {
      this.props.onChange(false);
      this.setState({ displaySide: false });
    } else if (
      !this.state.hide &amp;&amp;
      !currentWidthNav &amp;&amp;
      this.state.windowWidth &lt;= 991
    ) {
      this.setState({ displaySide: true });
      this.props.onChange(true);
    }
    this.setState({ windowWidth: window.innerWidth });
  }

  /**
   * Gestiona el mostrado de la barra lateral tras click del
   * usuario.
   */
  showSideBar() {
    this.props.onChange(!this.state.displaySide);
    this.setState({ displaySide: !this.state.displaySide });
    if (this.state.windowWidth &lt;= 991 &amp;&amp; !this.state.displaySide) {
      this.setState({ hide: false });
    } else {
      this.setState({ hide: !this.state.hide });
    }
  }

  /**
   * Muestra u oculta el dropdown del icono del usuario y añade
   * un EventListener para cuando se pulse fuera del dropdown se
   * cierre automáticamente.
   * @param {Event} event Evento al pulsar en el icono de usuario
   */
  showDropdown(event) {
    event.preventDefault();
    this.setState({ displayMenu: !this.state.displayMenu }, () => {
      document.addEventListener("click", this.hideDropdown);
    });
  }

  /**
   * Muestra u oculta el dropdown de las notificaciones y añade
   * un EventListener para cuando se pulse fuera del dropdown se
   * cierre automáticamente.
   * @param {Event} event Evento al pulsar en el icono de notificaciones
   */
  showDropdownNotif(event) {
    event.preventDefault();
    this.setState({ displayNotif: !this.state.displayNotif }, () => {
      document.addEventListener("click", this.hideDropdownNotif);
    });
  }

  /**
   * Muestra el dropdown del icono de usuario y elimina el
   * EventListener creado.
   */
  hideDropdown() {
    this.setState({ displayMenu: false }, () => {
      document.removeEventListener("click", this.hideDropdown);
    });
  }

  /**
   * Oculta el dropdown del icono de usuario y elimina el
   * EventListener creado.
   */
  hideDropdownNotif() {
    this.setState({ displayNotif: false }, () => {
      document.removeEventListener("click", this.hideDropdownNotif);
    });
  }
  /**
   * Resetea el reloj y lo inicializa para ejecutar la función
   * tick() una vez por segundo.
   */
  iniciarReloj() {
    this.pararReloj();
    this.timerID = setInterval(() => this.tick(), 1000);
  }
  /**
   * Detiene la ejecución del reloj.
   */
  pararReloj() {
    clearInterval(this.timerID);
  }
  /**
   * Suma un tick y si han pasado 5 ticks (5 segundos)
   * busca nuevas notificaciones y resetea el reloj.
   */
  tick() {
    let t = this.state.tiempoCheck;
    if (t === 5) {
      t = -1;
      this.pararReloj();
      this.getNotifications();
    }
    this.setState({ tiempoCheck: t + 1 });
  }

  render() {
    return (
      &lt;div>
        &lt;Navbar bg="light" className="shadow-sm mb-5 bg-white" fixed="top">
          &lt;Nav>
            &lt;Nav.Link onClick={this.showSideBar}>
              &lt;FaBars size={20} />
            &lt;/Nav.Link>
          &lt;/Nav>

          &lt;Navbar.Brand style={{ marginLeft: "15px", height: "40px" }}>
            &lt;Link to="/inicio">
              &lt;img
                alt="UniCast"
                src={brand}
                width="130"
                height="30"
                className="d-inline-block align-top"
              />{" "}
            &lt;/Link>
          &lt;/Navbar.Brand>

          &lt;BarraBusqueda nuevoTit={this.state.busqueda} />

          &lt;Nav className="ml-auto">
            &lt;Nav.Item
              style={{
                color: "#00000080",
                width: "36px",
                marginLeft: "3px"
              }}
            >
              &lt;div
                className="dropdown"
                style={{ top: "8px" }}
                onClick={() => this.setState({ bolaNotif: false })}
              >
                &lt;div style={{ position: "relative" }}>
                  &lt;FaBell size={20} onClick={this.showDropdownNotif} />
                  &lt;span
                    className="notificacion"
                    style={{
                      visibility: !this.state.bolaNotif ? "hidden" : "visible"
                    }}
                  >
                    {/*console.log(this.state.unCheckedNotifications)*/}
                    {this.state.unCheckedNotifications.length}
                  &lt;/span>
                &lt;/div>
                {this.state.displayNotif ? (
                  &lt;div className="dropdown-content" style={{ width: "340px" }}>
                    {this.state.unCheckedNotifications.length === 0 ? (
                      &lt;div
                        style={{
                          color: "#00000080",
                          fontSize: "12px"
                        }}
                      >
                        No hay nuevas notificaciones disponibles, ya las ha
                        revisado todas ellas.
                      &lt;/div>
                    ) : (
                      this.state.unCheckedNotifications.map(elmnt => {
                        const notif = elmnt.notification;
                        return (
                          &lt;Notificacion
                            key={notif.id}
                            notif={notif}
                            now={this.state.timeNow}
                          />
                        );
                      })
                    )}
                  &lt;/div>
                ) : null}
              &lt;/div>
            &lt;/Nav.Item>

            &lt;Nav.Item
              style={{
                marginLeft: "0",
                display: "block",
                padding: ".5rem .5rem"
              }}
            >
              &lt;Link to="/mensajes" style={{ color: "#00000080" }}>
                &lt;FaEnvelope size={20} />
              &lt;/Link>
            &lt;/Nav.Item>

            &lt;Nav.Item
              style={{
                color: "#00000080",
                width: "36px",
                marginLeft: "10px"
              }}
            >
              &lt;div className="dropdown" style={{ top: "5px" }}>
                &lt;img
                  alt="usuario"
                  src={getUserPhoto()}
                  width="30"
                  height="30"
                  onClick={this.showDropdown}
                  style={{ borderRadius: "50%" }}
                />
                {this.state.displayMenu ? (
                  &lt;div className="dropdown-content">
                    &lt;Link to="/perfil">Mi perfil&lt;/Link>
                    {getUserRole() === "ROLE_PROFESSOR" ? (
                      &lt;Link to="/mis-videos">Mis vídeos&lt;/Link>
                    ) : null}
                    &lt;Link to="/" onClick={() => signOut()}>
                      Cerrar Sesión
                    &lt;/Link>
                  &lt;/div>
                ) : null}
              &lt;/div>
            &lt;/Nav.Item>
          &lt;/Nav>
        &lt;/Navbar>
        &lt;div>
          &lt;BarraLateral
            activate={this.props.activar}
            show={this.state.displaySide ? "active" : ""}
            updateSubject={this.props.updateSubject}
          />
        &lt;/div>
      &lt;/div>
    );
  }
}

export default BarraNavegacion;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="BarraNavegacion.html">BarraNavegacion</a></li><li><a href="Notificacion.html">Notificacion</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addComment">addComment</a></li><li><a href="global.html#addMessage">addMessage</a></li><li><a href="global.html#addProfessor">addProfessor</a></li><li><a href="global.html#addReproductionList">addReproductionList</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#addVideotoReproductionList">addVideotoReproductionList</a></li><li><a href="global.html#addVote">addVote</a></li><li><a href="global.html#authUser">authUser</a></li><li><a href="global.html#borrarAsignatura">borrarAsignatura</a></li><li><a href="global.html#borrarProfeAsignatura">borrarProfeAsignatura</a></li><li><a href="global.html#borrarProfesor">borrarProfesor</a></li><li><a href="global.html#borrarUniversidad">borrarUniversidad</a></li><li><a href="global.html#checkFileExtensionImage">checkFileExtensionImage</a></li><li><a href="global.html#checkFileExtensionVideo">checkFileExtensionVideo</a></li><li><a href="global.html#checkNotification">checkNotification</a></li><li><a href="global.html#crearAsigYLigar">crearAsigYLigar</a></li><li><a href="global.html#crearCarreraYLigar">crearCarreraYLigar</a></li><li><a href="global.html#crearUniversidad">crearUniversidad</a></li><li><a href="global.html#deleteProfessor">deleteProfessor</a></li><li><a href="global.html#deleteReproductionList">deleteReproductionList</a></li><li><a href="global.html#deleteVideo">deleteVideo</a></li><li><a href="global.html#deleteVideoFromDisplay">deleteVideoFromDisplay</a></li><li><a href="global.html#deleteVideoFromReproductionList">deleteVideoFromReproductionList</a></li><li><a href="global.html#diasDelMes">diasDelMes</a></li><li><a href="global.html#emailPattern">emailPattern</a></li><li><a href="global.html#esAyer">esAyer</a></li><li><a href="global.html#esBisiesto">esBisiesto</a></li><li><a href="global.html#f_filterResults">f_filterResults</a></li><li><a href="global.html#f_scrollTop">f_scrollTop</a></li><li><a href="global.html#findSubjectByName">findSubjectByName</a></li><li><a href="global.html#findSubjectsContainingName">findSubjectsContainingName</a></li><li><a href="global.html#findUserProfessors">findUserProfessors</a></li><li><a href="global.html#findVideosContainingTitle">findVideosContainingTitle</a></li><li><a href="global.html#generadorColores">generadorColores</a></li><li><a href="global.html#getCommentsByVideo">getCommentsByVideo</a></li><li><a href="global.html#getDegreeOfUser">getDegreeOfUser</a></li><li><a href="global.html#getDegreesFromUnivesity">getDegreesFromUnivesity</a></li><li><a href="global.html#getDisplaysByUser">getDisplaysByUser</a></li><li><a href="global.html#getLastMessages">getLastMessages</a></li><li><a href="global.html#getMessagesFromSender">getMessagesFromSender</a></li><li><a href="global.html#getMessagesToReceiver">getMessagesToReceiver</a></li><li><a href="global.html#getProfessorsFromSubject">getProfessorsFromSubject</a></li><li><a href="global.html#getRecommendations">getRecommendations</a></li><li><a href="global.html#getReproductionListVideoIn">getReproductionListVideoIn</a></li><li><a href="global.html#getScore">getScore</a></li><li><a href="global.html#getSubjectById">getSubjectById</a></li><li><a href="global.html#getSubjectRanking">getSubjectRanking</a></li><li><a href="global.html#getSubjectsAsProfessor">getSubjectsAsProfessor</a></li><li><a href="global.html#getSubjectsFromUniveristy">getSubjectsFromUniveristy</a></li><li><a href="global.html#getSubjectsOfUser">getSubjectsOfUser</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getTimePassed">getTimePassed</a></li><li><a href="global.html#getUniversityOfUser">getUniversityOfUser</a></li><li><a href="global.html#getUnivesities">getUnivesities</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#getUserByUsername">getUserByUsername</a></li><li><a href="global.html#getUserID">getUserID</a></li><li><a href="global.html#getUserNotifications">getUserNotifications</a></li><li><a href="global.html#getUserPhoto">getUserPhoto</a></li><li><a href="global.html#getUserReproductionLists">getUserReproductionLists</a></li><li><a href="global.html#getUserRole">getUserRole</a></li><li><a href="global.html#getUserToken">getUserToken</a></li><li><a href="global.html#getUserUncheckedNotifications">getUserUncheckedNotifications</a></li><li><a href="global.html#getVideo">getVideo</a></li><li><a href="global.html#getVideoDisplay">getVideoDisplay</a></li><li><a href="global.html#getVideosFromReproductionList">getVideosFromReproductionList</a></li><li><a href="global.html#getVideosFromSubject">getVideosFromSubject</a></li><li><a href="global.html#getVideosFromUploader">getVideosFromUploader</a></li><li><a href="global.html#getVideoSubject">getVideoSubject</a></li><li><a href="global.html#hacerProfesor">hacerProfesor</a></li><li><a href="global.html#isSignedIn">isSignedIn</a></li><li><a href="global.html#ligarUniAsig">ligarUniAsig</a></li><li><a href="global.html#ligarUniCarr">ligarUniCarr</a></li><li><a href="global.html#mergeSortedArray">mergeSortedArray</a></li><li><a href="global.html#parsearFecha">parsearFecha</a></li><li><a href="global.html#parseNewMessages">parseNewMessages</a></li><li><a href="global.html#putFavouritesFirst">putFavouritesFirst</a></li><li><a href="global.html#RemoveAccents">RemoveAccents</a></li><li><a href="global.html#restriccion">restriccion</a></li><li><a href="global.html#restriccionNombre">restriccionNombre</a></li><li><a href="global.html#restriccionUser">restriccionUser</a></li><li><a href="global.html#scrollFunc">scrollFunc</a></li><li><a href="global.html#setUserPhoto">setUserPhoto</a></li><li><a href="global.html#setUserRole">setUserRole</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#signOut">signOut</a></li><li><a href="global.html#SubscribeSubject">SubscribeSubject</a></li><li><a href="global.html#UnsubscribeSubject">UnsubscribeSubject</a></li><li><a href="global.html#updateDisplay">updateDisplay</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#UploadVideo">UploadVideo</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.2</a> on Tue May 28 2019 18:26:06 GMT+0200 (hora de verano de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
